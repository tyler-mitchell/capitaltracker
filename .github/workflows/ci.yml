name: CI

on:
    push:
        tags:
            - '*'
        branches: [main]
    pull_request:
        branches: [main, develop]
        types: [opened, synchronize]

concurrency:
    group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
    cancel-in-progress: true

jobs:
    main:
        name: Nx Cloud - Main Job
        strategy:
            matrix:
                os: [ubuntu-latest]
                include:
                    - os: ubuntu-latest
        uses: nrwl/ci/.github/workflows/nx-cloud-main.yml@v0.11
        with:
            number-of-agents: 5
            environment-variables: |
                NEXT_TELEMETRY_DISABLED=1
            init-commands: |
                sudo apt-get update -y
                sudo apt-get install -y libgtk-3-dev webkit2gtk-4.0 libappindicator3-dev librsvg2-dev patchelf
            parallel-commands: |
                npx nx-cloud record -- npx nx workspace-lint
                npx nx-cloud record -- npx nx format:check
            parallel-commands-on-agents: |
                yarn ci:build --base=$NX_BASE --head=$NX_HEAD &
                yarn ci:format --base=$NX_BASE --head=$NX_HEAD &
                yarn ci:lint --base=$NX_BASE --head=$NX_HEAD &
                yarn ci:test --base=$NX_BASE --head=$NX_HEAD &
                yarn ci:e2e --base=$NX_BASE --head=$NX_HEAD

    agents:
        name: Nx Cloud - Agents
        uses: nrwl/ci/.github/workflows/nx-cloud-agents.yml@v0.11
        with:
            number-of-agents: 5
            environment-variables: |
                NEXT_TELEMETRY_DISABLED=1
